<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - NewLifeRun Club</title>
    <link rel="stylesheet" href="css/checkout.css?v=2.0" />
    <link rel="stylesheet" href="css/navbar.css?v=9.0" />
    <!-- üé® CUSTOM POPUPS - NewLifeRun Club Style -->
    <link rel="stylesheet" href="css/custom-popups.css?v=1.0" />

    <!-- üí≥ PayPal SDK -->
    <script>
      // Lista de Client IDs de backup para sandbox
      const PAYPAL_BACKUP_IDS = [
        "AYw421e3EEAo-iQhrDugwvRLekjQe8y9V4gOgTJn1snL_0FNnOS1SPVb2fxE83_NHmaNLB3ePut4g_N1", // Tu Client ID original
        "AZKFqPF_FpUy8_bQlLfzLlI_9verrIl_XXNWDlLzsj1iDKC-pHJBHkm0pjNfT1A8CQ45BWGnztEn8jjB", // Client ID oficial de demos
      ];

      let currentIdIndex = 1; // Empezar con el Client ID oficial

      // Cargar PayPal SDK din√°micamente
      function loadPayPalSDK() {
        return new Promise((resolve, reject) => {
          if (window.paypal) {
            resolve(window.paypal);
            return;
          }

          tryLoadPayPal(resolve, reject);
        });
      }

      function tryLoadPayPal(resolve, reject, retryCount = 0) {
        if (retryCount >= PAYPAL_BACKUP_IDS.length) {
          console.error("‚ùå Todos los Client IDs de PayPal fallaron");
          
          // Mostrar error espec√≠fico al usuario
          const container = document.getElementById("paypal-button-container");
          if (container) {
            container.innerHTML = `
              <div style="background: #ffebee; border: 1px solid #f44336; border-radius: 8px; padding: 15px; text-align: center; color: #d32f2f;">
                <strong>‚ö†Ô∏è Error cargando PayPal</strong><br>
                <small>Por favor, usa el m√©todo de dep√≥sito bancario o recarga la p√°gina.</small>
              </div>
            `;
          }
          
          reject(new Error("Todos los Client IDs fallaron"));
          return;
        }

        const clientId = PAYPAL_BACKUP_IDS[retryCount];
        console.log(
          `üîÑ Intentando cargar PayPal (intento ${retryCount + 1}/${
            PAYPAL_BACKUP_IDS.length
          })...`
        );
        console.log("üÜî Client ID:", clientId);

        const script = document.createElement("script");

        // üß™ SANDBOX MODE - Client ID con fallback
        script.src = `https://www.paypal.com/sdk/js?client-id=${clientId}&currency=USD&intent=capture&enable-funding=venmo,paylater,card&environment=sandbox`;

        console.log("üìç URL del SDK:", script.src);

        script.onload = () => {
          console.log("üì¶ Script PayPal cargado, verificando...");
          if (window.paypal) {
            console.log("‚úÖ PayPal SDK cargado exitosamente");
            resolve(window.paypal);
          } else {
            console.error("‚ùå PayPal SDK no se inicializ√≥ correctamente");
            // Intentar con el siguiente Client ID
            tryLoadPayPal(resolve, reject, retryCount + 1);
          }
        };

        script.onerror = (error) => {
          console.error(
            `‚ùå Error cargando PayPal SDK (intento ${retryCount + 1}):`,
            error
          );
          console.error("üîç URL intentada:", script.src);

          // Remover script fallido
          if (script.parentNode) {
            script.parentNode.removeChild(script);
          }

          // Intentar con el siguiente Client ID
          setTimeout(() => {
            tryLoadPayPal(resolve, reject, retryCount + 1);
          }, 1000);
        };

        console.log("üîÑ Agregando script PayPal al DOM...");
        document.head.appendChild(script);
      }
    </script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: #f5f5f5;
        line-height: 1.6;
      }

      /* Header */
      .header {
        background: #000;
        color: white;
        padding: 15px 0;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 24px;
        font-weight: bold;
        color: white;
        text-decoration: none;
      }

      .security-badges {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .security-badge {
        background: rgba(255, 255, 255, 0.1);
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      /* Progress Bar */
      .progress-container {
        background: white;
        border-bottom: 1px solid #e0e0e0;
        padding: 20px 0;
      }

      .progress-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      .progress-bar {
        display: flex;
        justify-content: center;
        margin-bottom: 10px;
      }

      .progress-step {
        flex: 1;
        max-width: 200px;
        text-align: center;
        position: relative;
        padding: 0 10px;
      }

      .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e0e0e0;
        color: #999;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin: 0 auto 10px;
        transition: all 0.3s;
      }

      .progress-step.active .step-circle {
        background: #000;
        color: white;
      }

      .progress-step.completed .step-circle {
        background: #4caf50;
        color: white;
      }

      .step-label {
        font-size: 14px;
        font-weight: 600;
        color: #666;
      }

      .progress-step.active .step-label {
        color: #000;
      }

      .step-line {
        position: absolute;
        top: 20px;
        left: 50%;
        width: 100%;
        height: 2px;
        background: #e0e0e0;
        z-index: -1;
      }

      .progress-step.completed .step-line {
        background: #4caf50;
      }

      /* Main Content */
      .main-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 40px;
      }

      .checkout-form {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .order-summary {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        height: fit-content;
        position: sticky;
        top: 120px;
      }

      .section {
        display: none;
        animation: fadeInSlide 0.4s ease-out;
      }

      .section.active {
        display: block;
      }

      @keyframes fadeInSlide {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .section-title {
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #000;
      }

      .section-subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 16px;
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 25px;
      }

      .form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
      }

      .form-input {
        width: 100%;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s;
        background: #fafafa;
      }

      .form-input:focus {
        outline: none;
        border-color: #000;
        background: white;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .form-row-3 {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 15px;
      }

      /* Payment Options */
      .payment-methods {
        display: grid;
        gap: 15px;
        margin-bottom: 25px;
      }

      .payment-option {
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fafafa;
      }

      .payment-option:hover {
        border-color: #000;
        background: white;
      }

      .payment-option.selected {
        border-color: #000;
        background: white;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
      }

      .payment-left {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .payment-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #000, #333);
        color: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }

      .payment-info h4 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 5px;
        color: #333;
      }

      .payment-info p {
        font-size: 14px;
        color: #666;
      }

      .radio-custom {
        width: 20px;
        height: 20px;
        border: 2px solid #e0e0e0;
        border-radius: 50%;
        position: relative;
        transition: all 0.3s;
      }

      .payment-option.selected .radio-custom {
        border-color: #000;
      }

      .payment-option.selected .radio-custom::after {
        content: "";
        width: 10px;
        height: 10px;
        background: #000;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      /* Security Features */
      .security-features {
        background: #f9f9f9;
        border-radius: 8px;
        padding: 20px;
        margin: 25px 0;
      }

      .security-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .security-list {
        display: grid;
        gap: 10px;
      }

      .security-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        color: #666;
      }

      .security-icon {
        width: 20px;
        height: 20px;
        background: #4caf50;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }

      /* Buttons */
      .btn-primary {
        width: 100%;
        background: linear-gradient(135deg, #000, #333);
        color: white;
        padding: 18px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, #333, #555);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .btn-secondary {
        width: 100%;
        background: white;
        color: #000;
        padding: 15px;
        border: 2px solid #000;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 15px;
        transition: all 0.3s;
      }

      .btn-secondary:hover {
        background: #000;
        color: white;
      }

      .btn-loading {
        position: relative;
        color: transparent;
      }

      .btn-loading::after {
        content: "";
        position: absolute;
        width: 20px;
        height: 20px;
        top: 50%;
        left: 50%;
        margin-left: -10px;
        margin-top: -10px;
        border: 2px solid transparent;
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Order Summary */
      .summary-title {
        font-size: 22px;
        font-weight: bold;
        margin-bottom: 25px;
        color: #000;
      }

      .product-item {
        display: flex;
        gap: 15px;
        padding: 20px 0;
        border-bottom: 1px solid #e0e0e0;
      }

      .product-img {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #f0f0f0, #e0e0e0);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        font-size: 12px;
        font-weight: bold;
      }

      .product-details {
        flex: 1;
      }

      .product-name {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 5px;
      }

      .product-specs {
        font-size: 14px;
        color: #666;
        margin-bottom: 10px;
      }

      .product-price {
        font-size: 16px;
        font-weight: bold;
      }

      .quantity-badge {
        background: #000;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
      }

      /* Controles de cantidad para checkout */
      .quantity-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #f8f9fa;
        border-radius: 20px;
        padding: 4px;
      }

      .qty-control-btn {
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 50%;
        background: #000;
        color: white;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .qty-control-btn:hover:not(:disabled) {
        background: #333;
        transform: scale(1.1);
      }

      .qty-control-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .quantity-display {
        min-width: 20px;
        text-align: center;
        font-weight: 600;
        font-size: 14px;
        color: #333;
      }

      .summary-totals {
        padding: 25px 0;
      }

      .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-size: 16px;
        color: #333;
      }

      .total-final {
        font-weight: bold;
        font-size: 20px;
        padding-top: 15px;
        border-top: 2px solid #000;
        color: #000;
      }

      .promo-code {
        margin: 25px 0;
      }

      .promo-input {
        display: flex;
        gap: 10px;
      }

      .promo-input input {
        flex: 1;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
      }

      .promo-btn {
        padding: 12px 20px;
        background: #000;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
      }

      /* Success Page */
      .success-container {
        text-align: center;
        padding: 40px 0;
      }

      .success-icon {
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 50px;
        margin: 0 auto 30px;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .token-display {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border: 2px dashed #000;
        border-radius: 12px;
        padding: 30px;
        margin: 30px 0;
      }

      .token-label {
        font-size: 14px;
        color: #666;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .token-value {
        font-size: 24px;
        font-weight: bold;
        font-family: "Courier New", monospace;
        color: #000;
        letter-spacing: 3px;
        margin-bottom: 15px;
      }

      .token-copy {
        background: #000;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .main-container {
          grid-template-columns: 1fr;
          gap: 20px;
          padding: 20px 15px;
        }

        .order-summary {
          order: -1;
          position: static;
        }

        .form-row {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .form-row-3 {
          grid-template-columns: 1fr;
        }

        .progress-bar {
          flex-direction: column;
          align-items: center;
          gap: 20px;
        }

        .progress-step {
          max-width: 100%;
        }

        .step-line {
          display: none;
        }

        .header-content {
          flex-direction: column;
          gap: 15px;
        }

        .security-badges {
          flex-wrap: wrap;
          justify-content: center;
        }
      }

      @media (max-width: 480px) {
        .checkout-form,
        .order-summary {
          padding: 20px;
        }

        .section-title {
          font-size: 24px;
        }

        .payment-option {
          flex-direction: column;
          text-align: center;
          gap: 15px;
        }

        .product-item {
          flex-direction: column;
          text-align: center;
        }
      }

      /* Quantity Controls */
      .quantity-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #f8f9fa;
        border-radius: 20px;
        padding: 4px;
      }

      .qty-btn {
        width: 28px;
        height: 28px;
        border: none;
        border-radius: 50%;
        background: #ff69b4;
        color: white;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .qty-btn:hover:not(:disabled) {
        background: #ff1493;
        transform: scale(1.1);
      }

      .qty-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .quantity {
        min-width: 30px;
        text-align: center;
        font-weight: 600;
        font-size: 14px;
        color: #333;
      }

      /* Cart Item Styles */
      .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .cart-item:last-child {
        border-bottom: none;
      }

      .cart-item-info {
        display: flex;
        gap: 15px;
        flex: 1;
      }

      .cart-item-image {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
      }

      .cart-item-details h4 {
        margin: 0 0 5px 0;
        font-size: 16px;
        font-weight: 600;
      }

      .cart-item-details p {
        margin: 2px 0;
        color: #666;
        font-size: 14px;
      }

      .cart-item-controls {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .remove-btn {
        background: #ff4444;
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .remove-btn:hover {
        background: #cc0000;
        transform: scale(1.1);
      }

      .clear-cart-btn {
        background: linear-gradient(135deg, #ff4444, #cc0000);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        margin-top: 20px;
        width: 100%;
        transition: all 0.3s ease;
      }

      .clear-cart-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
      }

      /* Bank Deposit Styles */
      .bank-deposit-info {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border: 2px solid #dee2e6;
        border-radius: 12px;
        padding: 25px;
        margin: 20px 0;
      }

      .bank-deposit-info h3 {
        color: #495057;
        margin-bottom: 15px;
        font-size: 18px;
      }

      .bank-accounts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .bank-account {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
      }

      .bank-account:hover {
        border-color: #ff69b4;
        box-shadow: 0 2px 8px rgba(255, 105, 180, 0.1);
        transform: translateY(-2px);
      }

      .bank-account.selected {
        border-color: #ff69b4;
        background: rgba(255, 105, 180, 0.05);
        box-shadow: 0 4px 15px rgba(255, 105, 180, 0.2);
        transform: translateY(-2px);
      }

      .bank-account.selected::after {
        content: "‚úì";
        position: absolute;
        top: 10px;
        right: 10px;
        background: #ff69b4;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
      }

      .bank-account h4 {
        color: #495057;
        margin-bottom: 8px;
        font-size: 16px;
      }

      .bank-account p {
        margin: 4px 0;
        font-size: 14px;
        color: #6c757d;
      }

      .bank-account strong {
        color: #495057;
      }

      .deposit-instructions {
        background: rgba(255, 105, 180, 0.1);
        border: 1px solid rgba(255, 105, 180, 0.3);
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
      }

      .deposit-instructions h4 {
        color: #ff1493;
        margin-bottom: 10px;
      }

      .deposit-instructions ol {
        margin: 0;
        padding-left: 20px;
      }

      .deposit-instructions li {
        margin: 5px 0;
        color: #495057;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <a href="index.html" class="logo">NewLifeRun Club</a>
        <div class="security-badges">
          <div class="security-badge"><span>üîí</span> Pago Seguro</div>
          <div class="security-badge"><span>üõ°Ô∏è</span> SSL Certificado</div>
          <div class="security-badge"><span>‚úì</span> Garant√≠a 30 d√≠as</div>
        </div>
      </div>
    </header>

    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-content">
        <div class="progress-bar">
          <div class="progress-step active" data-step="1">
            <div class="step-circle">1</div>
            <div class="step-label">Informaci√≥n</div>
            <div class="step-line"></div>
          </div>
          <div class="progress-step" data-step="2">
            <div class="step-circle">2</div>
            <div class="step-label">Env√≠o</div>
            <div class="step-line"></div>
          </div>
          <div class="progress-step" data-step="3">
            <div class="step-circle">3</div>
            <div class="step-label">Pago</div>
            <div class="step-line"></div>
          </div>
          <div class="progress-step" data-step="4">
            <div class="step-circle">‚úì</div>
            <div class="step-label">Confirmaci√≥n</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-container">
      <!-- Checkout Form -->
      <div class="checkout-form">
        <!-- Step 1: Contact Information -->
        <div class="section active" id="section-1">
          <h2 class="section-title">Informaci√≥n de Contacto</h2>
          <p class="section-subtitle">
            Completa tus datos para procesar tu pedido
          </p>

          <div class="form-group">
            <label class="form-label">Email *</label>
            <input
              type="email"
              class="form-input"
              placeholder="tu@email.com"
              id="email"
              required
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Nombre *</label>
              <input
                type="text"
                class="form-input"
                placeholder="Tu nombre"
                id="first-name"
                required
              />
            </div>
            <div class="form-group">
              <label class="form-label">Apellido *</label>
              <input
                type="text"
                class="form-input"
                placeholder="Tu apellido"
                id="last-name"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Tel√©fono *</label>
            <input
              type="tel"
              class="form-input"
              placeholder="+504 0000-0000"
              id="phone"
              required
            />
          </div>

          <button class="btn-primary" onclick="nextStep(2)">
            Continuar al Env√≠o
          </button>
        </div>

        <!-- Step 2: Shipping Information -->
        <div class="section" id="section-2">
          <h2 class="section-title">Informaci√≥n de Env√≠o</h2>
          <p class="section-subtitle">¬øD√≥nde quieres recibir tu pedido?</p>

          <div class="form-group">
            <label class="form-label">Direcci√≥n *</label>
            <input
              type="text"
              class="form-input"
              placeholder="Calle, n√∫mero, referencias"
              id="address"
              required
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Ciudad *</label>
              <input
                type="text"
                class="form-input"
                placeholder="Tegucigalpa"
                id="city"
                required
              />
            </div>
            <div class="form-group">
              <label class="form-label">Departamento *</label>
              <select class="form-input" id="state" required>
                <option value="">Seleccionar</option>
                <option value="francisco-morazan">Francisco Moraz√°n</option>
                <option value="cortes">Cort√©s</option>
                <option value="atlantida">Atl√°ntida</option>
                <option value="choluteca">Choluteca</option>
                <option value="el-paraiso">El Para√≠so</option>
                <option value="intibuca">Intibuc√°</option>
                <option value="lempira">Lempira</option>
                <option value="ocotepeque">Ocotepeque</option>
                <option value="olancho">Olancho</option>
                <option value="santa-barbara">Santa B√°rbara</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">C√≥digo Postal</label>
            <input
              type="text"
              class="form-input"
              placeholder="11101"
              id="zip"
            />
          </div>

          <div class="security-features">
            <div class="security-title"><span>üöö</span> Opciones de Env√≠o</div>
            <div class="security-list">
              <div class="security-item">
                <div class="security-icon">‚úì</div>
                <span
                  ><strong>Env√≠o Gratis</strong> en compras mayores a $75</span
                >
              </div>
              <div class="security-item">
                <div class="security-icon">‚úì</div>
                <span><strong>Entrega 2-5 d√≠as</strong> h√°biles</span>
              </div>
              <div class="security-item">
                <div class="security-icon">‚úì</div>
                <span
                  ><strong>Seguimiento en tiempo real</strong> de tu
                  pedido</span
                >
              </div>
            </div>
          </div>

          <button class="btn-primary" onclick="nextStep(3)">
            Continuar al Pago
          </button>
          <button class="btn-secondary" onclick="nextStep(1)">Regresar</button>
        </div>

        <!-- Step 3: Payment Information -->
        <div class="section" id="section-3">
          <h2 class="section-title">M√©todo de Pago</h2>
          <p class="section-subtitle">Selecciona tu m√©todo de pago preferido</p>

          <div class="payment-methods">
            <div
              class="payment-option selected"
              onclick="selectPayment(this, 'paypal')"
            >
              <div class="payment-left">
                <div class="payment-icon">üÖøÔ∏è</div>
                <div class="payment-info">
                  <h4>PayPal</h4>
                  <p>Paga con PayPal o tarjeta de cr√©dito/d√©bito</p>
                </div>
              </div>
              <div class="radio-custom"></div>
            </div>

            <div
              class="payment-option"
              onclick="selectPayment(this, 'bank-deposit')"
            >
              <div class="payment-left">
                <div class="payment-icon">üè¶</div>
                <div class="payment-info">
                  <h4>Dep√≥sito a Cuenta Bancaria</h4>
                  <p>Deposita directamente a nuestras cuentas</p>
                </div>
              </div>
              <div class="radio-custom"></div>
            </div>
          </div>

          <!-- Contenedor de PayPal (mostrado por defecto) -->
          <div id="paypal-details">
            <div
              style="
                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                border: 2px solid #0070ba;
                border-radius: 12px;
                padding: 25px;
                margin: 20px 0;
              "
            >
              <h3 style="color: #0070ba; margin-bottom: 15px; font-size: 18px">
                üí≥ Pago con PayPal
              </h3>
              <p style="color: #495057; margin-bottom: 20px">
                Ser√°s redirigido a PayPal para completar tu pago de forma
                segura. Puedes pagar con:
              </p>
              <div style="display: grid; gap: 10px; margin-bottom: 20px">
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    color: #495057;
                  "
                >
                  <div
                    style="
                      width: 20px;
                      height: 20px;
                      background: #0070ba;
                      color: white;
                      border-radius: 50%;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      font-size: 12px;
                    "
                  >
                    ‚úì
                  </div>
                  <span
                    ><strong>Tu cuenta PayPal</strong> - Si ya tienes una</span
                  >
                </div>
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    color: #495057;
                  "
                >
                  <div
                    style="
                      width: 20px;
                      height: 20px;
                      background: #0070ba;
                      color: white;
                      border-radius: 50%;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      font-size: 12px;
                    "
                  >
                    ‚úì
                  </div>
                  <span
                    ><strong>Tarjeta de cr√©dito/d√©bito</strong> - Sin necesidad
                    de cuenta PayPal</span
                  >
                </div>
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    color: #495057;
                  "
                >
                  <div
                    style="
                      width: 20px;
                      height: 20px;
                      background: #0070ba;
                      color: white;
                      border-radius: 50%;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      font-size: 12px;
                    "
                  >
                    ‚úì
                  </div>
                  <span
                    ><strong>Protecci√≥n del comprador</strong> - Garant√≠a
                    PayPal</span
                  >
                </div>
              </div>

              <!-- Aqu√≠ se cargar√° el bot√≥n de PayPal -->
              <div id="paypal-button-container" style="margin-top: 20px">
                <!-- El bot√≥n de PayPal se cargar√° aqu√≠ din√°micamente -->
              </div>
            </div>
          </div>

          <!-- Detalles de dep√≥sito bancario (oculto por defecto) -->
          <div id="bank-deposit-details" style="display: none">
            <div class="bank-deposit-info">
              <h3>üìã Informaci√≥n para Dep√≥sito</h3>
              <p>
                Realiza tu dep√≥sito a cualquiera de nuestras cuentas bancarias:
              </p>

              <p
                style="
                  background: rgba(255, 105, 180, 0.1);
                  border: 1px solid #ff69b4;
                  border-radius: 8px;
                  padding: 10px;
                  margin: 15px 0;
                  color: #495057;
                  font-weight: 600;
                "
              >
                üëÜ
                <strong
                  >Selecciona una cuenta bancaria haciendo clic en ella:</strong
                >
              </p>

              <div class="bank-accounts">
                <div class="bank-account" onclick="selectBankAccount(this)">
                  <h4>üè¶ BAC Honduras</h4>
                  <p><strong>N√∫mero de cuenta:</strong> 123445-BAC-001</p>
                  <p><strong>Tipo:</strong> Cuenta Corriente</p>
                </div>

                <div class="bank-account" onclick="selectBankAccount(this)">
                  <h4>üè¶ Banco Fichosa</h4>
                  <p><strong>N√∫mero de cuenta:</strong> 123445-FCH-002</p>
                  <p><strong>Tipo:</strong> Cuenta de Ahorros</p>
                </div>

                <div class="bank-account" onclick="selectBankAccount(this)">
                  <h4>üè¶ Banco Atl√°ntida</h4>
                  <p><strong>N√∫mero de cuenta:</strong> 123445-ATL-003</p>
                  <p><strong>Tipo:</strong> Cuenta Corriente</p>
                </div>

                <div class="bank-account" onclick="selectBankAccount(this)">
                  <h4>üè¶ Banpais</h4>
                  <p><strong>N√∫mero de cuenta:</strong> 123445-BNP-004</p>
                  <p><strong>Tipo:</strong> Cuenta de Ahorros</p>
                </div>
              </div>

              <div class="deposit-instructions">
                <h4>üìù Instrucciones:</h4>
                <ol>
                  <li>Realiza el dep√≥sito por el monto total mostrado</li>
                  <li>Conserva el comprobante de dep√≥sito</li>
                  <li>
                    Env√≠a foto del comprobante a:
                    <strong>info@newliferun.com</strong>
                  </li>
                  <li>Tu pedido ser√° procesado en 24-48 horas</li>
                </ol>
              </div>
            </div>
          </div>

          <div class="security-features">
            <div class="security-title">
              <span>üîê</span> Tu Pago est√° Protegido
            </div>
            <div class="security-list">
              <div class="security-item">
                <div class="security-icon">‚úì</div>
                <span
                  ><strong>Encriptaci√≥n SSL 256-bit</strong> - M√°xima
                  seguridad</span
                >
              </div>
              <div class="security-item">
                <div class="security-icon">‚úì</div>
                <span
                  ><strong>PCI DSS Compliant</strong> - Est√°ndares
                  internacionales</span
                >
              </div>
              <div class="security-item">
                <div class="security-icon">‚úì</div>
                <span
                  ><strong>Protecci√≥n contra fraude</strong> - Monitoreo
                  24/7</span
                >
              </div>
              <div class="security-item">
                <div class="security-icon">‚úì</div>
                <span
                  ><strong>Garant√≠a de devoluci√≥n</strong> - 30 d√≠as sin
                  preguntas</span
                >
              </div>
            </div>
          </div>

          <button
            class="btn-primary"
            id="payment-button"
            onclick="processPayment()"
            style="display: none"
          >
            Confirmar Pedido (Dep√≥sito Bancario) - L.0.00
          </button>
          <button class="btn-secondary" onclick="nextStep(2)">Regresar</button>
        </div>

        <!-- Step 4: Order Confirmation -->
        <div class="section" id="section-4">
          <div class="success-container">
            <div class="success-icon">‚úì</div>
            <h2 class="section-title">¬°Pago Exitoso!</h2>
            <p class="section-subtitle">
              Tu pedido ha sido procesado correctamente
            </p>

            <div class="token-display">
              <div class="token-label">Token de Compra</div>
              <div class="token-value" id="purchase-token">NRC-240608-A7X9</div>
              <button class="token-copy" onclick="copyToken()">
                Copiar Token
              </button>
            </div>

            <div class="security-features">
              <div class="security-title"><span>üìß</span> ¬øQu√© sigue?</div>
              <div class="security-list">
                <div class="security-item">
                  <div class="security-icon">1</div>
                  <span
                    >Recibir√°s un <strong>email de confirmaci√≥n</strong> en los
                    pr√≥ximos minutos</span
                  >
                </div>
                <div class="security-item">
                  <div class="security-icon">2</div>
                  <span
                    >Tu pedido ser√° <strong>procesado en 24 horas</strong></span
                  >
                </div>
                <div class="security-item">
                  <div class="security-icon">3</div>
                  <span
                    ><strong>Env√≠o y seguimiento</strong> te llegar√° por
                    SMS</span
                  >
                </div>
                <div class="security-item">
                  <div class="security-icon">4</div>
                  <span><strong>Entrega en 2-5 d√≠as</strong> h√°biles</span>
                </div>
              </div>
            </div>

            <button class="btn-primary" onclick="goHome()">
              Continuar Comprando
            </button>
          </div>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="order-summary">
        <h3 class="summary-title">Resumen del Pedido</h3>

        <!-- Productos del carrito -->
        <div id="cart-items">
          <!-- Los productos se cargar√°n din√°micamente aqu√≠ -->
        </div>

        <div class="promo-code">
          <div class="promo-input">
            <input
              type="text"
              placeholder="C√≥digo de descuento"
              id="promo-input"
            />
            <button class="promo-btn">Aplicar</button>
          </div>
        </div>

        <div class="summary-totals" id="cart-summary">
          <div class="total-row">
            <span>Subtotal:</span>
            <span class="subtotal-amount">L.0.00</span>
          </div>
          <div class="total-row">
            <span>Env√≠o:</span>
            <span class="shipping-amount">GRATIS</span>
          </div>
          <div class="total-row">
            <span>Impuestos (15%):</span>
            <span class="tax-amount">L.0.00</span>
          </div>
          <div class="total-row total-final">
            <span>Total:</span>
            <span class="total-amount">L.0.00</span>
          </div>
        </div>

        <div class="security-features">
          <div class="security-title"><span>üõ°Ô∏è</span> Compra Protegida</div>
          <div class="security-list">
            <div class="security-item">
              <div class="security-icon">‚úì</div>
              <span>Garant√≠a de satisfacci√≥n</span>
            </div>
            <div class="security-item">
              <div class="security-icon">‚úì</div>
              <span>Devoluciones gratis</span>
            </div>
            <div class="security-item">
              <div class="security-icon">‚úì</div>
              <span>Soporte 24/7</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Agregar script de checkout din√°mico -->
    <script src="js/checkout-handler.js"></script>

    <!-- Scripts necesarios -->
    <script src="js/cart-handler.js"></script>

    <script>
      let currentStep = 1;
      let selectedPaymentMethod = "card";

      function nextStep(step) {
        // Validar paso actual antes de continuar
        if (!validateCurrentStep()) {
          return;
        }

        // Actualizar paso anterior como completado
        const prevStep = document.querySelector(
          `.progress-step[data-step="${currentStep}"]`
        );
        if (prevStep && currentStep < step) {
          prevStep.classList.add("completed");
          prevStep.classList.remove("active");
        }

        // Ocultar secci√≥n actual
        document
          .getElementById(`section-${currentStep}`)
          .classList.remove("active");

        // Mostrar nueva secci√≥n
        currentStep = step;
        document
          .getElementById(`section-${currentStep}`)
          .classList.add("active");

        // Actualizar barra de progreso
        updateProgressBar();

        // Scroll to top
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function updateProgressBar() {
        document.querySelectorAll(".progress-step").forEach((step) => {
          const stepNum = parseInt(step.dataset.step);
          step.classList.remove("active");

          if (stepNum === currentStep) {
            step.classList.add("active");
          } else if (stepNum < currentStep) {
            step.classList.add("completed");
          }
        });
      }

      function validateCurrentStep() {
        const currentSection = document.getElementById(
          `section-${currentStep}`
        );
        const requiredInputs = currentSection.querySelectorAll(
          "input[required], select[required]"
        );

        for (let input of requiredInputs) {
          // üè¶ SKIP VALIDATION: Si es dep√≥sito bancario, no validar campos de tarjeta
          if (selectedPaymentMethod === "bank-deposit") {
            const cardFields = ["card-number", "expiry"];
            const cardNameField =
              input.placeholder && input.placeholder.includes("tarjeta");
            const cardCvvField =
              input.placeholder && input.placeholder.includes("123");

            if (
              cardFields.includes(input.id) ||
              cardNameField ||
              cardCvvField
            ) {
              console.log(
                "‚ö†Ô∏è Omitiendo validaci√≥n de campo de tarjeta:",
                input.id || input.placeholder
              );
              continue; // Saltar validaci√≥n de campos de tarjeta
            }
          }

          if (!input.value.trim()) {
            input.focus();
            input.style.borderColor = "#ff4444";
            setTimeout(() => {
              input.style.borderColor = "#e0e0e0";
            }, 3000);

            // Mostrar mensaje de error
            showNotification(
              "Por favor completa todos los campos requeridos",
              "error"
            );
            return false;
          }
        }

        // Validaciones espec√≠ficas por paso
        if (currentStep === 1) {
          const email = currentSection.querySelector(
            'input[type="email"]'
          ).value;
          if (!isValidEmail(email)) {
            showNotification("Por favor ingresa un email v√°lido", "error");
            return false;
          }
        }

        if (currentStep === 3 && selectedPaymentMethod === "card") {
          const cardNumber = document
            .getElementById("card-number")
            .value.replace(/\s/g, "");
          const expiry = document.getElementById("expiry").value;

          if (cardNumber.length < 16) {
            showNotification("N√∫mero de tarjeta inv√°lido", "error");
            return false;
          }

          if (expiry.length < 5) {
            showNotification("Fecha de vencimiento inv√°lida", "error");
            return false;
          }
        }

        // üè¶ VALIDACI√ìN PARA DEP√ìSITO BANCARIO: Verificar que se haya seleccionado una cuenta
        if (currentStep === 3 && selectedPaymentMethod === "bank-deposit") {
          const selectedBank = document.querySelector(".bank-account.selected");
          if (!selectedBank) {
            showNotification(
              "Por favor selecciona una cuenta bancaria para el dep√≥sito",
              "error"
            );
            return false;
          }
        }

        return true;
      }

      function isValidEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
      }

      // üè¶ NUEVA FUNCI√ìN: Seleccionar cuenta bancaria
      function selectBankAccount(bankElement) {
        // Remover selecci√≥n anterior
        document.querySelectorAll(".bank-account").forEach((bank) => {
          bank.classList.remove("selected");
        });

        // Seleccionar nueva cuenta
        bankElement.classList.add("selected");

        // Obtener nombre del banco
        const bankName = bankElement.querySelector("h4").textContent;
        console.log("üè¶ Cuenta bancaria seleccionada:", bankName);

        // Mostrar notificaci√≥n de selecci√≥n
        showNotification(`‚úÖ Cuenta seleccionada: ${bankName}`, "success");
      }

      function selectPayment(option, method) {
        // Remover selecci√≥n anterior
        document.querySelectorAll(".payment-option").forEach((opt) => {
          opt.classList.remove("selected");
        });

        // Seleccionar nueva opci√≥n
        option.classList.add("selected");
        selectedPaymentMethod = method;

        // Mostrar/ocultar detalles seg√∫n el m√©todo
        const paypalDetails = document.getElementById("paypal-details");
        const bankDetails = document.getElementById("bank-deposit-details");
        const paymentButton = document.getElementById("payment-button");

        if (method === "paypal") {
          paypalDetails.style.display = "block";
          bankDetails.style.display = "none";
          paymentButton.style.display = "none"; // Ocultar bot√≥n (PayPal tiene el suyo)
          // Inicializar PayPal cuando se selecciona
          initializePayPal();
        } else if (method === "bank-deposit") {
          paypalDetails.style.display = "none";
          bankDetails.style.display = "block";
          paymentButton.style.display = "block"; // Mostrar bot√≥n para dep√≥sito
        }
      }

      async function processPayment() {
        if (!validateCurrentStep()) {
          return;
        }

        const btn = event.target;
        const originalText = btn.textContent;

        // üìã RECOPILAR DATOS DEL FORMULARIO
        const datosFormulario = {
          email: document.getElementById("email")?.value || "",
          firstName: document.getElementById("first-name")?.value || "",
          lastName: document.getElementById("last-name")?.value || "",
          phone: document.getElementById("phone")?.value || "",
          address: document.getElementById("address")?.value || "",
          city: document.getElementById("city")?.value || "",
          state: document.getElementById("state")?.value || "Honduras",
          zip: document.getElementById("zip")?.value || "",
          paymentMethod:
            selectedPaymentMethod === "bank-deposit" ? "bank" : "card",
          cardNumber:
            selectedPaymentMethod === "card"
              ? document.getElementById("card-number")?.value || ""
              : null,
        };

        // Si es dep√≥sito bancario, mostrar mensaje especial
        if (selectedPaymentMethod === "bank-deposit") {
          await handleBankDepositPayment(datosFormulario);
          return;
        }

        // Mostrar estado de carga para tarjeta
        btn.classList.add("btn-loading");
        btn.disabled = true;
        btn.textContent = "Procesando pago...";

        try {
          // üõí PROCESAR COMPRA CON NUESTRA API
          console.log("üîÑ Procesando compra con la nueva API...");
          const resultadoAPI = await procesarCompraCompleta(datosFormulario);

          if (resultadoAPI.success) {
            // ‚úÖ Compra exitosa
            console.log(
              "‚úÖ Compra procesada exitosamente:",
              resultadoAPI.token
            );

            // Actualizar token en la p√°gina con el token real de la API
            document.getElementById("purchase-token").textContent =
              resultadoAPI.token;

            // üõçÔ∏è GUARDAR COMPRA EN HISTORIAL LOCAL (para compatibilidad)
            savePurchaseToHistory(resultadoAPI.token, "Tarjeta de Cr√©dito");

            // Actualizar contenido para pago con tarjeta
            updateSuccessPageForCard();

            // Mostrar notificaci√≥n de √©xito
            showNotification("¬°Pago procesado exitosamente!", "success");

            // Ir al paso de confirmaci√≥n
            nextStep(4);

            // Limpiar carrito despu√©s del pago exitoso
            clearCartAfterPurchase();
          } else {
            // ‚ùå Error en la API
            console.error("‚ùå Error en la API:", resultadoAPI.error);
            showNotification(`Error: ${resultadoAPI.error}`, "error");

            // Generar token local como fallback
            const tokenFallback = generateOrderToken();
            document.getElementById("purchase-token").textContent =
              tokenFallback;
            savePurchaseToHistory(tokenFallback, "Tarjeta de Cr√©dito");

            // Continuar con el flujo pero mostrar advertencia
            updateSuccessPageForCard();
            nextStep(4);
            clearCartAfterPurchase();
          }
        } catch (error) {
          // ‚ùå Error de conexi√≥n
          console.error("‚ùå Error procesando compra:", error);
          showNotification(
            "Error de conexi√≥n. Reintenta en unos momentos.",
            "error"
          );

          // Generar token local como fallback
          const tokenFallback = generateOrderToken();
          document.getElementById("purchase-token").textContent = tokenFallback;
          savePurchaseToHistory(tokenFallback, "Tarjeta de Cr√©dito");

          // Continuar con el flujo
          updateSuccessPageForCard();
          nextStep(4);
          clearCartAfterPurchase();
        }

        // Restaurar bot√≥n
        btn.classList.remove("btn-loading");
        btn.disabled = false;
        btn.textContent = originalText;
      }

      async function handleBankDepositPayment(datosFormulario = {}) {
        try {
          // üõí PROCESAR COMPRA CON NUESTRA API PARA DEP√ìSITO BANCARIO
          console.log("üè¶ Procesando pedido con dep√≥sito bancario...");
          const resultadoAPI = await procesarCompraCompleta(datosFormulario);

          let token;
          if (resultadoAPI.success) {
            // ‚úÖ Pedido exitoso
            token = resultadoAPI.token;
            console.log("‚úÖ Pedido registrado exitosamente:", token);
          } else {
            // ‚ùå Error en la API, usar token local
            console.error("‚ùå Error en la API:", resultadoAPI.error);
            token = generateOrderToken();
            showNotification(
              "Advertencia: Se gener√≥ un token local",
              "warning"
            );
          }

          // üõçÔ∏è GUARDAR COMPRA EN HISTORIAL
          savePurchaseToHistory(token, "Dep√≥sito Bancario");

          // Actualizar token en la p√°gina
          document.getElementById("purchase-token").textContent = token;

          // Actualizar contenido para dep√≥sito bancario
          updateSuccessPageForBankDeposit();

          // Ir al paso de confirmaci√≥n
          nextStep(4);

          // Limpiar carrito despu√©s del pedido
          clearCartAfterPurchase();
        } catch (error) {
          // ‚ùå Error de conexi√≥n, continuar con token local
          console.error("‚ùå Error procesando pedido:", error);
          const tokenFallback = generateOrderToken();

          document.getElementById("purchase-token").textContent = tokenFallback;
          savePurchaseToHistory(tokenFallback, "Dep√≥sito Bancario");
          updateSuccessPageForBankDeposit();
          nextStep(4);
          clearCartAfterPurchase();

          showNotification("Pedido registrado localmente", "warning");
        }
      }

      // üõçÔ∏è NUEVA FUNCI√ìN: Guardar compra en historial del usuario
      function savePurchaseToHistory(orderToken, paymentMethod) {
        const userEmail = localStorage.getItem("userEmail");
        if (!userEmail) {
          console.log("‚ö†Ô∏è No hay usuario loggeado, no se guarda el historial");
          return;
        }

        // Obtener informaci√≥n del carrito
        const cartItems = getCartItems();
        if (!cartItems || cartItems.length === 0) {
          console.log("‚ö†Ô∏è No hay productos en el carrito");
          return;
        }

        // Calcular total
        let total = 0;
        cartItems.forEach((item) => {
          total += parseFloat(item.price) * item.quantity;
        });

        // Crear objeto de compra
        const purchase = {
          id: orderToken,
          fecha: new Date().toLocaleDateString("es-HN"),
          hora: new Date().toLocaleTimeString("es-HN", {
            hour: "2-digit",
            minute: "2-digit",
          }),
          productos: cartItems.map((item) => ({
            nombre: item.name,
            precio: item.price,
            cantidad: item.quantity,
            categoria: item.category || "General",
            imagen:
              item.image ||
              "https://via.placeholder.com/60x60/ff69b4/FFFFFF?text=NL",
          })),
          total: total.toFixed(2),
          metodoPago: paymentMethod,
          estado:
            paymentMethod === "Dep√≥sito Bancario"
              ? "Pendiente de Confirmaci√≥n"
              : "Procesado",
          userEmail: userEmail,
        };

        // Obtener historial existente del usuario
        const historyKey = `purchaseHistory_${userEmail}`;
        let userHistory = JSON.parse(localStorage.getItem(historyKey)) || [];

        // Agregar nueva compra al inicio
        userHistory.unshift(purchase);

        // Limitar a las √∫ltimas 50 compras
        if (userHistory.length > 50) {
          userHistory = userHistory.slice(0, 50);
        }

        // Guardar historial actualizado
        localStorage.setItem(historyKey, JSON.stringify(userHistory));

        console.log("üõçÔ∏è Compra guardada en historial:", purchase);
      }

      // üõçÔ∏è FUNCI√ìN AUXILIAR: Obtener items del carrito
      function getCartItems() {
        try {
          const cartData = localStorage.getItem("newlife_cart");
          if (!cartData) return [];

          const cart = JSON.parse(cartData);
          // ‚úÖ FIXED: El carrito es un array directo, no objeto con items
          return Array.isArray(cart) ? cart : cart.items || [];
        } catch (error) {
          console.error("Error al obtener items del carrito:", error);
          return [];
        }
      }

      function clearCartAfterPurchase() {
        // Limpiar carrito del localStorage
        localStorage.removeItem("newlife_cart");

        // Tambi√©n limpiar el contador del carrito en la interfaz
        if (typeof updateCartDisplay === "function") {
          updateCartDisplay();
        }

        // Actualizar contador visualmente si existe
        const cartCounters = document.querySelectorAll(
          ".cart-count, #cart-count"
        );
        cartCounters.forEach((counter) => {
          counter.textContent = "0";
          counter.style.display = "none";
        });

        console.log("üõí Carrito limpiado completamente despu√©s de la compra");
      }

      function generateOrderToken() {
        const prefix = "NRC";
        const date = new Date()
          .toISOString()
          .slice(0, 10)
          .replace(/-/g, "")
          .slice(2);
        const random = Math.random().toString(36).substr(2, 4).toUpperCase();
        return `${prefix}-${date}-${random}`;
      }

      function copyToken() {
        const token = document.getElementById("purchase-token").textContent;

        if (navigator.clipboard) {
          navigator.clipboard.writeText(token).then(() => {
            showNotification("Token copiado al portapapeles", "success");
          });
        } else {
          // Fallback para navegadores antiguos
          const textArea = document.createElement("textarea");
          textArea.value = token;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand("copy");
          document.body.removeChild(textArea);
          showNotification("Token copiado al portapapeles", "success");
        }
      }

      function goHome() {
        showNotification(
          "¬°Gracias por tu compra! Redirigiendo al inicio...",
          "success"
        );

        // Asegurar limpieza final del carrito
        clearCartAfterPurchase();

        setTimeout(() => {
          // Redireccionar espec√≠ficamente a index.html
          window.location.href = "index.html";
        }, 2000);
      }

      function showNotification(message, type = "info") {
        // Crear notificaci√≥n
        const notification = document.createElement("div");
        notification.className = `notification notification-${type}`;
        notification.textContent = message;

        // Estilos de la notificaci√≥n
        notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${
                  type === "error"
                    ? "#ff4444"
                    : type === "success"
                    ? "#4CAF50"
                    : "#333"
                };
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            `;

        document.body.appendChild(notification);

        // Remover despu√©s de 3 segundos
        setTimeout(() => {
          notification.style.animation = "slideOutRight 0.3s ease-in";
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, 3000);
      }

      // Formateo autom√°tico de campos
      document.addEventListener("input", function (e) {
        // Formatear n√∫mero de tarjeta
        if (e.target.id === "card-number") {
          let value = e.target.value.replace(/\s/g, "");
          let formattedValue = value.replace(/(.{4})/g, "$1 ").trim();
          if (formattedValue.length <= 19) {
            e.target.value = formattedValue;
          }
        }

        // Formatear fecha de vencimiento
        if (e.target.id === "expiry") {
          let value = e.target.value.replace(/\D/g, "");
          if (value.length >= 2) {
            value = value.substring(0, 2) + "/" + value.substring(2, 4);
          }
          e.target.value = value;
        }

        // Solo n√∫meros en CVV
        if (e.target.placeholder === "123") {
          e.target.value = e.target.value.replace(/\D/g, "");
        }
      });

      // Agregar animaciones CSS
      const style = document.createElement("style");
      style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
      document.head.appendChild(style);

      // Inicializar
      document.addEventListener("DOMContentLoaded", function () {
        console.log("NewLifeRun Club Checkout - Inicializado");

        // Cargar carrito al iniciar
        setTimeout(() => {
          if (typeof loadCartInCheckout === "function") {
            loadCartInCheckout();
          }

          // Verificar si hay productos en el carrito
          const cartInfo = getCartInfo();
          if (cartInfo.count === 0) {
            showNotification(
              "Tu carrito est√° vac√≠o. Redirigiendo a la tienda...",
              "info"
            );
            setTimeout(() => {
              window.location.href = "tienda.html";
            }, 3000);
          }

          // üí≥ Inicializar PayPal por defecto (ya que est√° seleccionado)
          selectedPaymentMethod = "paypal";
          // Inicializar PayPal con el nuevo m√©todo
          initializePayPal();
        }, 200);
      });

      // Funci√≥n para procesamiento de tarjeta
      async function processCardPayment() {
        // Aqu√≠ ir√≠a la integraci√≥n con la pasarela de pagos real
        await showAlert(
          "Procesando pago con tarjeta...\n\nEsta es una demo. En producci√≥n se integrar√° con la pasarela de pagos real.",
          "info",
          "üí≥ Procesando Pago"
        );
        return true;
      }

      // üõ†Ô∏è FUNCIONES FALTANTES: Actualizar p√°gina de √©xito
      function updateSuccessPageForCard() {
        // Actualizar mensaje para pago con tarjeta
        const successContainer = document.querySelector(".success-container");
        if (successContainer) {
          const subtitle = successContainer.querySelector(".section-subtitle");
          if (subtitle) {
            subtitle.textContent =
              "Tu pago con tarjeta ha sido procesado exitosamente";
          }
        }

        // Actualizar instrucciones espec√≠ficas para tarjeta
        const securityFeatures = document.querySelector(
          "#section-4 .security-features"
        );
        if (securityFeatures) {
          const securityTitle =
            securityFeatures.querySelector(".security-title");
          if (securityTitle) {
            securityTitle.innerHTML = "<span>üí≥</span> ¬øQu√© sigue?";
          }
        }

        console.log("‚úÖ P√°gina de √©xito actualizada para pago con tarjeta");
      }

      function updateSuccessPageForBankDeposit() {
        // Actualizar mensaje para dep√≥sito bancario
        const successContainer = document.querySelector(".success-container");
        if (successContainer) {
          const subtitle = successContainer.querySelector(".section-subtitle");
          if (subtitle) {
            subtitle.textContent =
              "Tu pedido ha sido registrado. Completa el dep√≥sito para procesar tu orden";
          }
        }

        // Actualizar instrucciones espec√≠ficas para dep√≥sito
        const securityFeatures = document.querySelector(
          "#section-4 .security-features"
        );
        if (securityFeatures) {
          const securityTitle =
            securityFeatures.querySelector(".security-title");
          if (securityTitle) {
            securityTitle.innerHTML =
              "<span>üè¶</span> Instrucciones de Dep√≥sito";
          }

          // Cambiar las instrucciones para dep√≥sito bancario
          const securityList = securityFeatures.querySelector(".security-list");
          if (securityList) {
            securityList.innerHTML = `
              <div class="security-item">
                <div class="security-icon">1</div>
                <span>Realiza el <strong>dep√≥sito por el monto total</strong> mostrado arriba</span>
              </div>
              <div class="security-item">
                <div class="security-icon">2</div>
                <span>Conserva el <strong>comprobante de dep√≥sito</strong></span>
              </div>
              <div class="security-item">
                <div class="security-icon">3</div>
                <span>Env√≠a foto del comprobante a: <strong>info@newliferun.com</strong></span>
              </div>
              <div class="security-item">
                <div class="security-icon">4</div>
                <span>Tu pedido ser√° <strong>procesado en 24-48 horas</strong></span>
              </div>
            `;
          }
        }

        console.log("‚úÖ P√°gina de √©xito actualizada para dep√≥sito bancario");
      }

      // üí≥ NUEVA FUNCI√ìN: Inicializar PayPal
      async function initializePayPal() {
        try {
          console.log("üîÑ Iniciando carga de PayPal SDK...");

          // Cargar PayPal SDK
          const paypal = await loadPayPalSDK();

          // Limpiar contenedor anterior
          const container = document.getElementById("paypal-button-container");
          if (!container) {
            console.error("‚ùå Contenedor de PayPal no encontrado");
            return;
          }

          container.innerHTML = "";

          // Obtener informaci√≥n del carrito
          const cartInfo = getCartInfo();
          // üí∞ USAR EL TOTAL FINAL (con impuestos) y convertir a USD
          const totalLempiras = cartInfo.total;
          const exchangeRate = 0.0398; // 1 Lempira = 0.0398 USD (tasa real 2024)
          const totalUSD = (totalLempiras * exchangeRate).toFixed(2);

          console.log("üí≥ Inicializando PayPal:");
          console.log("- Total en Lempiras:", totalLempiras);
          console.log("- Total en USD:", totalUSD);

          // Renderizar botones de PayPal
          paypal
            .Buttons({
              style: {
                color: "blue",
                shape: "rect",
                label: "pay",
                height: 50,
              },

              createOrder: function (data, actions) {
                return actions.order.create({
                  purchase_units: [
                    {
                      amount: {
                        value: totalUSD,
                        currency_code: "USD",
                      },
                      description: `Compra NewLifeRun Club - L.${totalLempiras.toFixed(
                        2
                      )}`,
                    },
                  ],
                });
              },

              onApprove: function (data, actions) {
                return actions.order.capture().then(function (details) {
                  console.log("‚úÖ Pago PayPal exitoso:", details);

                  // Procesar pago exitoso
                  handlePayPalSuccess(details);
                });
              },

              onError: function (err) {
                console.error("‚ùå Error en PayPal:", err);
                showNotification(
                  "Error procesando el pago con PayPal",
                  "error"
                );
              },

              onCancel: function (data) {
                console.log("‚ö†Ô∏è Pago PayPal cancelado:", data);
                showNotification("Pago cancelado", "warning");
              },
            })
            .render("#paypal-button-container");
        } catch (error) {
          console.error("‚ùå Error inicializando PayPal:", error);

          // Mostrar mensaje de error al usuario
          const container = document.getElementById("paypal-button-container");
          if (container) {
            container.innerHTML = `
              <div style="background: #ffebee; border: 1px solid #f44336; border-radius: 8px; padding: 15px; text-align: center; color: #d32f2f;">
                <strong>‚ö†Ô∏è Error cargando PayPal</strong><br>
                Por favor, usa el m√©todo de dep√≥sito bancario o recarga la p√°gina.
              </div>
            `;
          }
        }
      }

      // üí≥ NUEVA FUNCI√ìN: Manejar √©xito de PayPal
      async function handlePayPalSuccess(paypalDetails) {
        try {
          console.log("üéâ Procesando √©xito de PayPal...");

          // Recopilar datos del formulario
          const datosFormulario = {
            email: document.getElementById("email")?.value || "",
            firstName: document.getElementById("first-name")?.value || "",
            lastName: document.getElementById("last-name")?.value || "",
            phone: document.getElementById("phone")?.value || "",
            address: document.getElementById("address")?.value || "",
            city: document.getElementById("city")?.value || "",
            state: document.getElementById("state")?.value || "Honduras",
            zip: document.getElementById("zip")?.value || "",
            paymentMethod: "PayPal",
            paypalTransactionId: paypalDetails.id,
            paypalPayerEmail: paypalDetails.payer?.email_address,
          };

          // üõí PROCESAR COMPRA CON NUESTRA API
          console.log("üîÑ Guardando compra PayPal en base de datos...");
          const resultadoAPI = await procesarCompraCompleta(datosFormulario);

          let token;
          if (resultadoAPI.success) {
            // ‚úÖ Compra exitosa en la API
            token = resultadoAPI.token;
            console.log("‚úÖ Compra PayPal guardada exitosamente:", token);
          } else {
            // ‚ùå Error en la API, usar token local
            console.error("‚ùå Error en la API:", resultadoAPI.error);
            token = generateOrderToken();
            showNotification(
              "Advertencia: Pago exitoso, guardado localmente",
              "warning"
            );
          }

          //  GUARDAR EN HISTORIAL LOCAL
          savePurchaseToHistory(token, "PayPal");

          // Actualizar token en la p√°gina
          document.getElementById("purchase-token").textContent = token;

          // Actualizar p√°gina de √©xito para PayPal
          updateSuccessPageForPayPal(paypalDetails);

          // Ir al paso de confirmaci√≥n
          nextStep(4);

          // Limpiar carrito
          clearCartAfterPurchase();

          // Mostrar notificaci√≥n de √©xito
          showNotification("¬°Pago con PayPal exitoso!", "success");
        } catch (error) {
          console.error("‚ùå Error procesando √©xito de PayPal:", error);

          // Generar token de fallback
          const tokenFallback = generateOrderToken();
          document.getElementById("purchase-token").textContent = tokenFallback;
          savePurchaseToHistory(tokenFallback, "PayPal");

          // Continuar con el flujo
          updateSuccessPageForPayPal(paypalDetails);
          nextStep(4);
          clearCartAfterPurchase();

          showNotification("Pago exitoso, guardado localmente", "warning");
        }
      }

      // üí≥ NUEVA FUNCI√ìN: Actualizar p√°gina de √©xito para PayPal
      function updateSuccessPageForPayPal(paypalDetails) {
        const successContainer = document.querySelector(".success-container");
        if (successContainer) {
          const subtitle = successContainer.querySelector(".section-subtitle");
          if (subtitle) {
            subtitle.textContent =
              "Tu pago con PayPal ha sido procesado exitosamente";
          }
        }

        // Actualizar instrucciones espec√≠ficas para PayPal
        const securityFeatures = document.querySelector(
          "#section-4 .security-features"
        );
        if (securityFeatures) {
          const securityTitle =
            securityFeatures.querySelector(".security-title");
          if (securityTitle) {
            securityTitle.innerHTML = "<span>üí≥</span> Pago PayPal Confirmado";
          }

          const securityList = securityFeatures.querySelector(".security-list");
          if (securityList) {
            securityList.innerHTML = `
              <div class="security-item">
                <div class="security-icon">‚úì</div>
                <span><strong>Pago procesado</strong> - ID: ${paypalDetails.id.substring(
                  0,
                  10
                )}...</span>
              </div>
              <div class="security-item">
                <div class="security-icon">‚úì</div>
                <span><strong>Email de confirmaci√≥n</strong> enviado a tu correo</span>
              </div>
              <div class="security-item">
                <div class="security-icon">‚úì</div>
                <span><strong>Pedido en preparaci√≥n</strong> - Procesamiento en 24h</span>
              </div>
              <div class="security-item">
                <div class="security-icon">‚úì</div>
                <span><strong>Env√≠o y seguimiento</strong> por SMS en 2-5 d√≠as</span>
              </div>
            `;
          }
        }

        console.log("‚úÖ P√°gina de √©xito actualizada para PayPal");
      }
    </script>
    <!-- üé® CUSTOM POPUPS SYSTEM -->
    <script src="js/custom-popups.js?v=1.0"></script>
  </body>
</html>
